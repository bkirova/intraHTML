// intraHTML: a better innerHTML (partial/non-destructive updates) for faster and simpler view rendering. (c)2015:dandavis, [CCBY4/MIT]  1.0.0 updated 15/11/12 
// usage: intraHTML(element, strNewInnerHTMLContent);
// includes a slightly modified copy of the odiff JS library by Billy Tetrud, under a modified MIT license per "Free to use for any purpose" from https://github.com/Tixit/odiff/blob/master/odiff.js
(function(B,w){"object"==typeof exports&&exports&&"string"!=typeof exports.nodeName?module.exports=w():"function"==typeof define&&define.amd?define(["exports"],w()):B.intraHTML=w(B)})(this,function(B){function w(b){var c=w.temp;return c.innerHTML=b,c.content}function F(b,c,k){if(!(2>arguments.length))for(var g=b.length,l=0;l<g;l++)c(b[l],l,b)}function v(b,c){for(var k=b.length,g=[],l=0;l<k;l++)c(b[l],l,b)&&g.push(b[l]);return g}function G(b,c){function k(b){var c=[],e=0,d,n,f=b.childNodes.length;for(e;e<f;e++)if(d=b.childNodes[e],d.tagName){n={$:d.tagName.toLowerCase()};for(var h=0,a=d.attributes,x,q=a.length;h<q;h++)x=a[h],n[x.name]=x.value;n._=[],c.push.apply(n._,k(d)),0===n._.length&&delete n._,c.push(n)}else c.push(d.nodeValue);return c}return"string"==typeof b?k(z(b,c))[0]:k({tagName:c||"div",attributes:[],childNodes:[b]})[0]}function K(b,c){var k=[],g=0,l=b.length,e=c,d;for(g;g<l&&(d=b[g],"_"===d&&(d="childNodes"),k.push(e),e=e[d],void 0!==e);g++);return{node:e,parents:k}}function L(b,c){var k=[],g=0,l=b.length,e=c;for(g;g<l&&(k.push(e),e=e[b[g]],void 0!==e);g++);return{node:e,parents:k}}function C(b){var c="",k,g=[],l=g.hasOwnProperty;if(b===k)return"";for(var e in b)l.call(b,e)&&"$"!==e&&"_"!==e&&(k=" "+e,""!==b[e]&&(k+="="+JSON.stringify(b[e])),c+=k);if(M[b.$])return"<"+b.$+c+" />";(k=b._||[],!Array.isArray(k))&&(k=[k]);for(var l=g.length=0,d=k.length;l<d;l++)e=k[l]||"",g[l]="object"==typeof e?C(e):""+e;return"<"+b.$+c+">"+g.join("")+"</"+b.$+">"}function H(b,c,k){k=performance.now();var g=this.debug,l=v(b.path.concat(b.index||b.key),function(a,b,h){return a!=b.xsdgdfg}),e=l.slice,d=v(l,function(a,b,h){return a!=b.xsdgdfg}).slice(-1)[0],n=K(l,this.dest),f=L(l,this.vdom),h=v(n.parents,Boolean),a={type:b.type,index:c,path:l,key:d,elm:n.node||n.parents.slice(-1)[0],elmParents:h,elmParent:h.slice(-1)[0],dest:this.dest,parents:f,parent:f.parents.slice(-1)[0],velm:f.node,vdom:this.vdom,isElm:"string"!=typeof f.node,isAttrib:!(d-.1)&&"_"!=d&&"$"!=d,change:b};"function"==typeof a.elm&&(a.elm=a.elmParent),g&&console.info("CHANGE: "+c,a);switch(b.type){case"set":if(!a.isAttrib&&("string"==typeof b.val||Array.isArray(b.val))){a.elmParent.childNodes||(a.elmParent=a.elmParent[a.key]),a.elm||(a.elm=a.elmParent),e=b.val,Array.isArray(e)||(e=[e]);for(var x=0,l=e.length;x<l;x++){c=e[x];if("string"==typeof c)if(a.elm instanceof NodeList&&(a.elm=v(a.elmParents,function(a,b,h){return a.textContent!==a.fsdhjklghdklg}).pop()),a.elm.childNodes){g&&console.log("set: non attrib, string, elm: ",a.key,[c],a.elm.outerHTML),n=document.createTextNode(c);if("_"===a.key)a.elm.textContent=c;else{if("$"===a.key){f=document.createElement(b.val),g&&console.warn("changing tag name!",b),a.elm.parentNode.insertBefore(f,a.elm);for(var q=a.elm.attributes,h=0,u=q.length;h<u;h++){var D=q[h];f.setAttribute(D.name,D.value)}q=a.elm.childNodes,h=0;for(u=q.length;h<u;h++)f.appendChild(q[0])}else a.elm.parentNode.insertBefore(n,a.elm);a.elm.parentNode.removeChild(a.elm)}b.elm=n}else g&&console.log("set: non attrib, string, not elm",c),a.elm.textContent=c,b.elm=a.elm;else n="string"==typeof c?document.createTextNode(c):z(C(c),a.elmParent[0]&&a.elmParent[0].parentNode.tagName).firstChild,a.elm.parentNode||(a.elm=a.elmParent),(f=a.elm.childNodes[+d+x])?(g&&console.log("set: non attrib, not string, has old",c),a.elm.insertBefore(n,f),a.elm.removeChild(a.elm)):(g&&console.log("set: non attrib, not string, no old, appending",[c,n,n.outerHTML||n.textContent]),a.elm.appendChild(n));"_"==d&&(d=0,a.parent.length||(a.parent=a.parent._||(a.parent._=[]))),g&&console.info("attempting key change",+d+x,!!(1.1-d),d,x,c,a.parent[+d+x],[a.parent])}break}if(a.isAttrib){if("$"==d&&String(l)==d)throw new TypeError("You cannot change the root element of an update-bound element: "+a.elm.outerHTML);if("$"==d){f=document.createElement(b.val),g&&console.warn("changing tag name!",b),a.elm.parentNode.insertBefore(f,a.elm),q=a.elm.attributes,h=0;for(u=q.length;h<u;h++)D=q[h],f.setAttribute(D.name,D.value);q=a.elm.childNodes,h=0;for(u=q.length;h<u;h++)f.appendChild(q[0]);b.elm=f,a.elm.parentNode.removeChild(a.elm)}else!a.elm.setAttribute&&a.elm.parentNode&&a.elm.parentNode.setAttribute&&(a.elm=a.elm.parentNode),!a.elm.setAttribute&&(x=v(a.elmParents,function(a,b,h){return a.setAttribute}).slice(-1)[0]).setAttribute&&(a.elm=x),b.val===b.dgfjkdfl34534fd?a.elm.removeAttribute(d):a.elm.setAttribute(d,b.val),b.elm=a.elm;break}if(a.elm.length&&b.val===b.sdgfdf)for(g=0,d=a.elm.length;g<d;g++)a.elm[0].parentNode.removeChild(a.elm[0]);else a.elm instanceof NodeList&&(a.elm=v(a.elmParents,function(a,b,h){return a.textContent!==a.fsdhjklghdklg}).pop()),f=z(C(b.val),a.parent.$).firstChild,g&&console.log("element replacing",[a.elm.outerHTML||a.elm.textContent]," with ",[f.outerHTML]),b.elm=f,a.elm.parentNode.insertBefore(f,a.elm),a.elm.parentNode.removeChild(a.elm);break;case"add":a.isAttrib||("_"==a.key&&(a.elm=a.elm[b.index],a.key=b.index,a.parent=a.parent._,a.elmParent=a.elmParent.childNodes),F(b.vals,function(h,d,c){a.elmParent.length||(a.elmParent=a.elmParents.slice(-1)[0].childNodes),a.elmParent||(a.elmParent=a.elmParents.slice(-2)[0].childNodes),c="string"==typeof h?document.createTextNode(h):z(C(h),a.elmParent[0]&&a.elmParent[0].parentNode.tagName).firstChild;var q=a.elmParent[a.key+d];b.elm=c,q?(q.parentNode.insertBefore(c,q),a.parent.splice(a.key+d,0,h)):a.elmParent[a.key+d]?a.elmParent[a.key+d]=c:(h=a.elmParents.slice(-1)[0],h[0]&&(h=h[h.length-1]),a.elm&&a.elm.length>=a.key&&(h=a.elm[0].parentNode),h instanceof NodeList&&(h=v(a.elmParents,function(a,b,h){return a.textContent!==a.fsdhjklghdklg}).pop()),h!==c&&(3!=h.nodeType?h.appendChild(c):(h.parentNode.insertBefore(c,h),h.parentNode.insertBefore(h,c))))}));break;case"rm":if(a.elmParent.childNodes&&(a.elmParent=a.elmParent.childNodes),0===a.elmParent.length&&(a.elmParent=a.elmParents.slice(-3)[0]),a.elmParent.childNodes&&(a.elmParent=a.elmParent.childNodes),a.parent._&&(a.parent=a.parent._),d=e.call(a.elmParent,b.index-b.num+1,b.index+1),0===b.index){g&&console.log("removing many from zero",e.call(a.parent),a.elmParent,"|||",a.parent[0],b.index,b.num),h=b.index;for(u=h+b.num;h<u;h++)a.elmParent[b.index].remove();b.elm=a.elmParent}else-1<b.index-b.num?1===b.num?(d=[a.elmParent[b.index]],g&&console.log("removing one",a.elmParent,d[0].outerHTML,b.index,e.call(a.elmParent).map(function(a){return a.outerHTML||a.nodeValue}),a.parent)):b.index+b.num<a.elmParent.length+1?(d=b.index,1<d&&"Z"===b.mode&&(d-=b.num-1),g&&console.log("removing many up",b.mode,a.elmParent,d,d+b.num),d=e.call(a.elmParent,d,d+b.num)):(g&&console.log("removing many down",e.call(a.elmParent),b.index-b.num,b.index),d=e.call(a.elmParent,b.index-b.num+1,b.index+1)):(g&&console.log("removing many negative",a.elmParent,b.index,b.index+b.num),d=e.call(a.elmParent,b.index,b.index+b.num)),d.length&&(b.elm=d[0].parentNode),g&&console.log("removing:",d,b,a.parent.slice(b.index-b.num+1,b.index+1)),F(d,function(a,b,h){a.parentNode.removeChild(a)})}b.runtime=performance.now()-k}function E(b,c,k){var g=performance.now();"string"==typeof b&&(b=document.querySelector(b));var l=b.tagName.toLowerCase(),e=b.outerHTML,d=e.slice(0,e.indexOf(">"))+">",n=e.slice(d.length,e.lastIndexOf("<")-1);if(k&&k.trim()===n.trim())return{update:Boolean};n||(n=b.innerHTML=" "),c||(c=e);if(c instanceof Element||"string"==typeof c)c=G(c,l);k=performance.now();var f={dest:b,vdom:c,debug:t.debug,initTime:k-g,update:function(b){var a=performance.now();return"string"==typeof b&&(b=G(d+b+"</"+l+">",l)),f.parseTime=performance.now()-a,f.vdom2=b,a=performance.now(),f.changes=J(f.vdom,b),f.diffTime=performance.now()-a,a=performance.now(),F(f.changes,H.bind(f)),f.applyTime=performance.now()-a,f.vdom=b,f}};return E.last=f}function t(b,c){return t._last=E(b,b,c),t._last.update(c)}Number.isNaN||(Number.isNaN=function(b){return"number"==typeof b&&isNaN(b)}),Array.isArray||(Array.isArray=function(b){return"[object Array]"===Object.prototype.toString.call(b)});var J=function(b,c){function k(b,a,c,d,e,g,l){for(var k=d-g,f=e-l,n=Math.max(k,f),m=1;m<=n;m++){var t=a[d-m],I=c[e-m];if(m<=f&&m<=k&&b(t,I))return{a:d-m,b:e-m};for(var A=0;A<m;A++){var w=a[d-A],v=c[e-A];if(m<=f&&b(w,I))return{a:d-A,b:e-m};if(m<=k&&b(t,v))return{a:d-m,b:e-A}}}return{a:g-1,b:l-1}}function g(b,a){if(Array.isArray(b)){if(!Array.isArray(a))return!1;for(var c=b.length/15,q=Math.abs(b.length-a.length),g=0;g<b.length;g++)if(l(b[g],a[g])){if(2<=q&&q>c||q===b.length)return!1;q++}return!0}if("object"==typeof b){if("object"!=typeof a)return!1;var g=d(e(Object.keys(b)),e(Object.keys(a))),k=Object.keys(g).length,c=k/15,q=0,f;for(f in g)if(!l(b[f],a[f])){if(2<=q&&q>c||q+1===k)return!1;q++}return!0}return b===a||Number.isNaN(b)&&Number.isNaN(a)}function l(b,a){if(Array.isArray(b)){if(Array.isArray(a)&&b.length===a.length&&b[0]===a[0]){for(var c=0;c<b.length;c++)if(!l(b[c],a[c]))return!1;return!0}return!1}if(b instanceof Object){if(a instanceof Object){var d=Object.keys(b),c=Object.keys(a);if(d.length!==c.length)return!1;for(c=0;c<d.length;c++){var e=d[c];if(!l(b[e],a[e]))return!1}return!0}return!1}return b===a||Number.isNaN(b)&&Number.isNaN(a)}function e(b){var a=0,c=b.length,d={};for(a;a<c;a++)d[b[a]]=!0;return d}function d(b,a){for(var c in a)b[c]=a[c];return b}var n=function(b,a,c,f){function u(a,b,c){a.push({type:"set",path:b,val:c})}function t(a,b,c,d,e){a.push({type:"rm",path:b,index:c,num:d,mode:e})}function w(a,b,c,d){a.push({type:"add",path:b,index:c,vals:d})}if(!(b===a||Number.isNaN(b)&&Number.isNaN(a)))if(Array.isArray(b)&&Array.isArray(a)){for(var p=b.length-1,r=a.length-1;0<=p&&0<=r;)if(l(b[p],a[r]))p--,r--;else{for(var y=k(l,b,a,p,r,0,0),m=p;m>y.a&&r>y.b;)if(g(b[m],a[r]))n(b[m],a[r],c,f.concat([m])),m--,r--;else{var p=k(g,b,a,m,r,y.a+1,y.b+1),m=m-p.a,v=r-p.b;1===m&&1===v?u(c,f.concat(p.a+1),a[p.b+1]):1===m&&2===v?(w(c,f,p.a+2,a.slice(p.b+2,r+1)),u(c,f.concat(p.a+1),a[p.b+1])):2===m&&1===v?(t(c,f,p.a+2,1,"I"),u(c,f.concat(p.a+1),a[p.b+1])):2===m&&2===v?(u(c,f.concat(p.a+2),a[p.b+2]),u(c,f.concat(p.a+1),a[p.b+1])):(0<m&&t(c,f,p.a+1,m,"X"),0<v&&w(c,f,p.a+1,a.slice(p.b+1,r+1))),m=p.a,r=p.b}m>y.a?t(c,f,m,m-y.a,"Z"):r>y.b&&w(c,f,m+1,a.slice(y.b+1,r+1)),p=y.a,r=y.b}0<=p?t(c,f,0,p+1):0<=r&&w(c,f,0,a.slice(0,r+1))}else if("object"==typeof b&&"object"==typeof a)for(r in y=d(e(Object.keys(b)),e(Object.keys(a))),y)n(b[r],a[r],c,f.concat([r]));else u(c,f,a)},f=[];return n(b,c,f,[]),f};w.temp=document.createElement("template");var z=function(b,c){var k=document.createElement(c||"div");return k.innerHTML=b,k};"content"in document.createElement("template")&&(z=w);var M={area:1,base:1,br:1,col:1,command:1,embed:1,hr:1,img:1,input:1,keygen:1,link:1,meta:1,param:1,source:1,track:1,wbr:1};return t.odiff=J,t.updater=E,t.applyChanges=H,t.toHTML=C,t.fromHTML=G,t.elementFromString=z,t.getRenderer=E,B.jQuery&&(B.jQuery.fn.intraHTML=function(b){return this.each(function(c,k){t(k,b)}),this}),t});
